<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Freezer - JavaScript blog</title>
    <link rel="stylesheet" href="../css/main.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,600|Source+Serif+Pro|Source+Code+Pro:400,600' rel='stylesheet' type='text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/styles/default.min.css">

  </head>
  <body>
    <script src="../js/codeoutput.js"></script>
    <div id="logo">
      <img src="../img/the-freezer.svg">
      <p>JavaScript blog</p>
    </div>
    <div id="container">

      <h1>Minimum Viable View Library (part 1: the View)</h1>

      <p><i>Posted by <a href="http://www.pakastin.fi" target="_blank">Juha Lindstedt</a> on January xx, 2016</i></p>

      <p>I'm going to teach you how to build a fully capable and extremely performant view library weighting just few kilobytes. We will begin by creating a View in this first post.</p>

      <h2>Creating elements</h2>

      <p>Before we're going to build a View, let's see how HTML elements are created in Vanilla JavaScript.</p>

      <h3>Basics</h3>

      <p>Creating HTML elements is quite easy:</p>

      <pre><code class="javascript">
// create elements
var h1 = document.createElement('h1');
var p = document.createElement('p');

// add text
h1.textContent = 'Hello world';
p.textContent = 'Vanilla JavaScript rocks!';

// add to DOM
document.body.appendChild(h1);
document.body.appendChild(p);

// result
// &lt;body&gt;&lt;h1&gt;Hello world!&lt;/h1&gt;&lt;p&gt;Lorem ipsum dolor sit amet&lt;/p&gt;&lt;/body&gt;

      </code></pre>

      <script>codeOutput(0);</script>

      <h3>Helper</h3>

      <p>We'll make it even easier with a little helper function:</p>

      <pre><code class="javascript">
function el (tagName, attributes) {
  var element = document.createElement(tagName);

  // go through attributes and set them
  for (var attributeName in attributes) {
    element[attributeName] = attributes[attributeName];
  }

  return element;
}

      </code></pre>

      <h3>Usage</h3>

      <p>Couldn't be smoother to use:</p>

      <pre><code class="javascript">
// create elements
var h1 = el('h1', { textContent: 'Hello WRLD!' });
var p = el('p', { textContent: 'This is a bit easier..' });

// add to DOM
document.body.appendChild(h1);
document.body.appendChild(p);

      </code></pre>

      <script>codeOutput(1, 2);</script>

      <h2>View</h2>
      <h3>Constructor</h3>

      <p>Now let's get to business and define a View:</p>

      <pre><code class="javascript">
function View (options, data) {
  for (var key in options) {
    if (key === 'el') {
      // little trick here to pass the parameters to the el helper
      if (typeof options.el === 'string') {
        this.el = el(options.el);
      } else if (options.el instanceof Array) {
        this.el = el(options.el[0], options.el[1]);
      } else {
        this.el = options.el;
      }
    } else {
      this[key] = options[key];
    }
  }
  // let's get back to this line later
  if (this.init) this.init(data);
}

</code></pre>
<h3>Mounting children</h3>
<p>Then add some child mounting methods:</p>
<pre><code class="javascript">
View.prototype.addChild = function (childView) {
  if (this.mount) this.mount();

  this.el.appendChild(childView.el);
  childView.parentView = this;
};

View.prototype.addBefore = function (childView, before) {
  if (this.mount) this.mount();

  this.el.insertBefore(childView.el, before.el || before);
  childView.parentView = this;
};

</code></pre>

<h3>Usage</h3>
<p>Time to try it out!</p>

<pre><code class="javascript">
var body = new View({ el: document.body });

var h1 = new View({
  el: ['h1', { textContent: 'Hello View!' }]
});

var p = new View({
  el: ['p', { innerHTML: "Works like the train toilet.&lt;br&gt;&lt;i&gt;(Finnish proverb)&lt;/i&gt;" }]
});

body.addChild(h1);
body.addChild(p);

</code></pre>

<script>codeOutput(1, 3, 4, 5);</script>

<h3>Add/reorder/remove</h3>
<p>Time for some magic. Here's one simple method to add/reorder/remove child views:</p>

<pre><code class="javascript">
View.prototype.setChildren = function (views) {
  // traverse the DOM starting from the first child element (if present)
  var traverse = this.el.firstChild;

  // go through given views (if any)
  if (views) {
    for (var i = 0; i < views.length; i++) {
      if (views[i].el === traverse) {
        // element already in place, continue to next sibling
        traverse = traverse.nextSibling;
        continue;
      }

      // insert/reorder element to the dom
      if (traverse) {
        this.addBefore(views[i], traverse);
      } else {
        this.addChild(views[i]);
      }
    }
  }

  // remove any DOM nodes left out
  while (traverse) {
    var next = traverse.nextSibling;
    this.el.removeChild(traverse);
    traverse = next;
  }
}
      </code></pre>

      <h3>Example</h3>
      <p>Let's create a list of Views and start to shuffle:<br>

      <pre><code class="javascript">
var body = new View({ el: document.body });
var ul = new View({ el: 'ul' });
var views = new Array(10);

for (var i = 0; i < views.length; i++) {
  views[i] = new View({
    el: ['li', { textContent: 'Item ' + i }]
  });
}
ul.setChildren(views);

body.addChild(ul);

setInterval(function () {
  views.sort(function () { return Math.random() * 2 - 1; });
  ul.setChildren(views);
}, 250);

      </code></pre>

      <script>codeOutput(1, 3, 4, 6, 7);</script>

      <h3>Extending helper</h3>

      <p>Let's add extending helper:</p>

      <pre><code class="javascript">

View.extend = function (options) {
  function ExtendedView (data) {
    View.call(this, options, data);
  }

  ExtendedView.prototype = Object.create(View.prototype);
  ExtendedView.prototype.constructor = ExtendedView;

  return ExtendedView;
}

      </code></pre>

      <h3>Example</h3>

      <p>Now we can start building components and measure how performant our tiny view library is!</p>

      <pre><code class="javascript">
// our list element component
var Li = View.extend({
  el: 'li',
  init: function (data) {
    this.el.textContent = data;
  }
})

var body = new View({ el: document.body });
var ul = new View({ el: 'ul' });

// let's create list of views
var views = new Array(100);

for (var i = 0; i < views.length; i++) {
  views[i] = new Li('Item ' + i);
}

// add to DOM
ul.setChildren(views);

// let's see how fast we're running
var fps = new View({ el : 'p' });

body.addChild(fps);
body.addChild(ul);

// average fps calculation starts..

var lastFrame = Date.now();
var frameTimeTotal = 0;
var frameTimeCount = 0;

tick();

function tick () {
  requestAnimationFrame(tick);
  var now = Date.now();

  // take last element and move to first
  views.unshift(views.pop());

  // update views
  ul.setChildren(views);

  frameTimeTotal += (now - lastFrame);
  frameTimeCount++;

  lastFrame = now;
};

setInterval(function () {
  fps.el.textContent = 'Running at ' + (1000 / (frameTimeTotal / frameTimeCount)).toFixed(2) + ' fps';
}, 1000);

      </code></pre>

      <script>codeOutput(1, 3, 4, 6, 8, 9);</script>

      <h3>More coming soon</h3>

      <p>Work in progress...</p>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/highlight.min.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
  </body>
</html>
